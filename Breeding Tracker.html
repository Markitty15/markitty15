<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breeding Projects Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter and Atomic Age -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Atomic+Age&display=swap" rel="stylesheet">
    <!-- React and ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Apply Atomic Age to h1 only, h2 and buttons will use Inter unless specified */
        h1 {
            font-family: 'Atomic Age', cursive;
        }
        /* New class for headings that should use Atomic Age font */
        .atomic-age-heading {
            font-family: 'Atomic Age', cursive;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- The React app will render here -->
    </div>

    <script type="text/babel">
        // Import React hooks
        const { useState, useEffect, useRef } = React;

        // Function to generate a shaded version of a hex color
        const shadeColor = (hex, percent) => {
            let f = parseInt(hex.slice(1), 16),
                t = percent < 0 ? 0 : 255,
                p = Math.abs(percent),
                R = f >> 16,
                G = (f >> 8) & 0x00ff,
                B = f & 0x0000ff;

            const newR = Math.round((t - R) * p) + R;
            const newG = Math.round((t - G) * p) + G;
            const newB = Math.round((t - B) * p) + B;

            const toHex = (c) => {
                const h = Math.min(255, Math.max(0, c)).toString(16);
                return h.length === 1 ? "0" + h : h;
            };

            return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
        };

        // Define hex values for common Tailwind colors used in themes for calculations
        const tailwindColorsHex = {
            'gray-100': '#F3F4F6', 'white': '#FFFFFF', 'gray-200': '#E5E7EB',
            'gray-900': '#111827', 'gray-600': '#4B5563', 'blue-700': '#1D4ED8',
            'green-600': '#16A34A', 'gray-50': '#F9FAFB', 'gray-300': '#D1D5DB',
            'gray-400': '#9CA3AF', 'gray-700': '#374151', 'gray-800': '#1F2937',
            'gray-950': '#030712', 'gray-500': '#6B7280', 'gray-600': '#4B5563',
            'blue-300': '#93C5FD', 'green-300': '#86EFAD', 'cyan-400': '#22D3EE',
            'teal-400': '#2DD4BF', 'blue-950': '#172554', 'blue-900': '#1E3A8A',
            'blue-800': '#1F2937', 'blue-700': '#1D4ED8',
            'green-100': '#DCFCE7', 'green-50': '#F0FDF4', 'green-200': '#BBF7D0',
            'green-700': '#047857', 'green-800': '#065F46',
            'orange-100': '#FFEDD5', 'yellow-300': '#FCD34D', 'orange-800': '#9A3412',
            'orange-500': '#F97316', 'orange-600': '#EA580C', 'yellow-600': '#CA8A04',
            'yellow-200': '#FDE68A', 'yellow-400': '#FACC15', 'yellow-500': '#EAB308',
            'yellow-50': '#FFFBEB', 'yellow-100': '#FEF3C7', 'yellow-700': '#A16207',
            'yellow-800': '#854D09', 'red-500': '#EF4444', 'red-700': '#B91C1C',
            'red-300': '#FCA5A5', 'red-400': '#F87171', 'red-600': '#DC2626',
            'black': '#000000',
            // New custom colors
            'DAC0CF': '#DAC0CF', '5A2A46': '#5A2A46', '331032': '#331032',
            'E2A3C7': '#E2A3C7', '60435F': '#60435F', 'E6DAE1': '#E6DAE1',
            'pastel-green': '#C8FCD7', // A light pastel green
            'dark-mocha-brown': '#211100', // A very dark, rich brown for mocha theme
            'light-global-text': '#F0F0F0', // Global light text color
            'dark-global-text': '#1A1A1A',  // Global dark text color
            'D58936': '#D58936', // Mocha base
            '502419': '#502419', // Mocha accent
            '85FFC7': '#85FFC7', // Teal base
            '297373': '#297373', // Teal accent
        };

        // Helper to get hex from Tailwind class
        const getHexFromTailwindClass = (className) => {
            const match = className.match(/bg-\[(#[0-9a-fA-F]{6})\]/);
            if (match) return match[1];
            // Handle custom hex colors directly if they are passed as 'bg-[#HEX]'
            if (className.startsWith('bg-[') && className.endsWith(']')) {
                return className.substring(4, className.length - 1);
            }
            const colorName = className.replace(/bg-|border-|text-/, '');
            return tailwindColorsHex[colorName] || '#000000'; // Default to black if not found
        };

        // Function to determine if a hex color is light or dark for general text contrast, and return a *derived* contrasting color
        // It takes the background color and two base text colors (one light, one dark) to choose from.
        const getContrastTextColor = (backgroundHex, lightTextColorHex, darkTextColorHex) => {
            // Convert hex to RGB
            const r = parseInt(backgroundHex.substring(1, 3), 16);
            const g = parseInt(backgroundHex.substring(3, 5), 16);
            const b = parseInt(backgroundHex.substring(5, 7), 16);

            // Calculate luminance (using W3C standards for accessibility)
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

            // Use a threshold (e.g., 0.5 for general light/dark, or adjust for specific contrast needs)
            if (luminance > 0.5) { // Background is light, need dark text
                return `text-[${darkTextColorHex}]`;
            } else { // Background is dark, need light text
                return `text-[${lightTextColorHex}]`;
            }
        };

        // Function to determine text color specifically for input/display boxes
        // It takes the input background color and two base text colors (one light, one dark) to choose from.
        const getSpecialInputTextColor = (inputBgHex, lightTextColorHex, darkTextColorHex) => {
            const r = parseInt(inputBgHex.substring(1, 3), 16);
            const g = parseInt(inputBgHex.substring(3, 5), 16);
            const b = parseInt(inputBgHex.substring(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

            // A slightly higher threshold might be good for input fields to ensure readability
            // Let's use a similar approach as getContrastTextColor for simplicity and consistency.
            if (luminance > 0.5) { // Input background is light, need dark text
                return `text-[${darkTextColorHex}]`;
            } else { // Input background is dark, need light text
                return `text-[${lightTextColorHex}]`;
            }
        };

        // Define theme configurations
        const themes = {
          'white-grey': {
            name: 'White & Grey',
            bgScreen: 'bg-gray-100',
            bgContainer: 'bg-white',
            borderContainer: 'border-gray-200',
            textAccent: 'text-blue-700', // Static accent
            textSuccess: 'text-green-600', // Static success
            bgSection: 'bg-gray-50',
            borderSection: 'border-gray-200',
            bgButtonAdd: 'bg-gray-300',
            hoverBgButtonAdd: 'hover:bg-gray-400',
            focusRingButtonAdd: 'focus:ring-gray-300',
            bgButtonPrimary: 'bg-gray-300',
            hoverBgButtonPrimary: 'hover:bg-gray-400',
            focusRingButtonPrimary: 'focus:ring-gray-300',
            bgMessage: 'bg-gray-100',
            bgResult: 'bg-gray-100',
            borderResult: 'border-gray-300',
            bgGoalItem: 'bg-white',
            borderGoalItem: 'border-gray-200',
            textDeleteButton: 'text-red-500',
            hoverTextDeleteButton: 'hover:text-red-700',
            bgSubNavActive: 'bg-gray-500',
            bgSubNavInactive: 'bg-gray-400',
            hoverBgSubNav: 'hover:bg-gray-600',

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-gray-100'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass('bg-white'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-gray-50'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-gray-50'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-gray-300'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-gray-300'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-gray-300'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass('bg-gray-100'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
          'slate-grey': {
            name: 'Slate Grey',
            bgScreen: 'bg-gray-600',
            bgContainer: 'bg-gray-700',
            borderContainer: 'border-gray-500',
            textAccent: 'text-blue-300',
            textSuccess: 'text-green-300',
            bgInput: 'bg-gray-600',
            borderInput: 'border-gray-500',
            focusBorderInput: 'focus:border-blue-400',
            focusRingInput: 'focus:ring-blue-400',
            bgSection: 'bg-gray-600',
            borderSection: 'border-gray-500',
            bgButtonAdd: 'bg-gray-800',
            hoverBgButtonAdd: 'hover:bg-gray-900',
            focusRingButtonAdd: 'focus:ring-gray-700',
            bgButtonPrimary: 'bg-gray-800',
            hoverBgButtonPrimary: 'hover:bg-gray-900',
            focusRingButtonPrimary: 'focus:ring-gray-700',
            bgMessage: 'bg-gray-600',
            bgResult: 'bg-gray-600',
            borderResult: 'border-gray-500',
            bgGoalItem: 'bg-gray-700',
            borderGoalItem: 'border-gray-600',
            textDeleteButton: 'text-red-300',
            hoverTextDeleteButton: 'hover:text-red-500',
            bgSubNavActive: 'bg-gray-950',
            bgSubNavInactive: 'bg-gray-900',
            hoverBgSubNav: 'hover:bg-black',

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-gray-600'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass('bg-gray-700'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-gray-600'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-gray-600'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-gray-800'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-gray-800'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-gray-800'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass('bg-gray-600'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
          'mint-green': {
            name: 'Mint Green',
            bgScreen: 'bg-green-100',
            bgContainer: 'bg-green-50',
            borderContainer: 'border-green-200',
            textAccent: 'text-green-700',
            textSuccess: 'text-green-800',
            bgInput: 'bg-white',
            borderInput: 'border-green-200',
            focusBorderInput: 'focus:border-green-500',
            focusRingInput: 'focus:ring-green-500',
            bgSection: 'bg-white',
            borderSection: 'border-green-200',
            bgButtonAdd: 'bg-green-700',
            hoverBgButtonAdd: 'hover:bg-green-800',
            focusRingButtonAdd: 'focus:ring-green-600',
            bgButtonPrimary: 'bg-green-700',
            hoverBgButtonPrimary: 'hover:bg-green-800',
            focusRingButtonPrimary: 'focus:ring-green-600',
            bgMessage: 'bg-green-100',
            bgResult: 'bg-green-100',
            borderResult: 'border-green-300',
            bgGoalItem: 'bg-green-50',
            borderGoalItem: 'border-green-200',
            textDeleteButton: 'text-red-500',
            hoverTextDeleteButton: 'hover:text-red-700',
            bgSubNavActive: 'bg-green-900',
            bgSubNavInactive: 'bg-green-800',
            hoverBgSubNav: 'hover:bg-green-950',

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-green-100'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass('bg-green-50'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-white'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-white'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-green-700'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-green-700'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-green-700'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass('bg-green-100'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
          'navy-blue': {
            name: 'Navy Blue',
            bgScreen: 'bg-blue-950',
            bgContainer: 'bg-blue-900',
            borderContainer: 'border-blue-800',
            textAccent: 'text-cyan-400',
            textSuccess: 'text-teal-400',
            bgInput: 'bg-blue-800',
            borderInput: 'border-blue-700',
            focusBorderInput: 'focus:border-cyan-500',
            focusRingInput: 'focus:ring-cyan-500',
            bgSection: 'bg-blue-800',
            borderSection: 'border-blue-700',
            bgButtonAdd: 'bg-blue-700',
            hoverBgButtonAdd: 'hover:bg-blue-800',
            focusRingButtonAdd: 'focus:ring-blue-600',
            bgButtonPrimary: 'bg-blue-700',
            hoverBgButtonPrimary: 'hover:bg-blue-800',
            focusRingButtonPrimary: 'focus:ring-blue-600',
            bgMessage: 'bg-blue-800',
            bgResult: 'bg-blue-800',
            borderResult: 'border-blue-700',
            bgGoalItem: 'bg-blue-900',
            borderGoalItem: 'border-blue-800',
            textDeleteButton: 'text-red-400',
            hoverTextDeleteButton: 'hover:text-red-600',
            bgSubNavActive: 'bg-blue-950',
            bgSubNavInactive: 'bg-blue-900',
            hoverBgSubNav: 'hover:bg-blue-900',

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-blue-950'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass('bg-blue-900'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-blue-800'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-blue-800'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-blue-700'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-blue-700'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-blue-700'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass('bg-blue-800'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
          'candy-corn': {
            name: 'Candy Corn',
            bgScreen: 'bg-orange-100',
            bgContainer: 'bg-white',
            borderContainer: 'border-yellow-300',
            textAccent: 'text-orange-600',
            textSuccess: 'text-yellow-600',
            bgInput: 'bg-white',
            borderInput: 'border-yellow-200',
            focusBorderInput: 'focus:border-orange-500',
            focusRingInput: 'focus:ring-orange-500',
            bgSection: 'bg-white',
            borderSection: 'border-yellow-200',
            bgButtonAdd: 'bg-yellow-400',
            hoverBgButtonAdd: 'hover:bg-yellow-500',
            focusRingButtonAdd: 'focus:ring-yellow-300',
            bgButtonPrimary: 'bg-yellow-400',
            hoverBgButtonPrimary: 'hover:bg-yellow-500',
            focusRingButtonPrimary: 'focus:ring-yellow-300',
            bgMessage: 'bg-yellow-50',
            bgResult: 'bg-yellow-50',
            borderResult: 'border-yellow-200',
            bgGoalItem: 'bg-white',
            borderGoalItem: 'border-yellow-100',
            textDeleteButton: 'text-red-500',
            hoverTextDeleteButton: 'hover:text-red-700',
            bgSubNavActive: 'bg-yellow-700',
            bgSubNavInactive: 'bg-yellow-600',
            hoverBgSubNav: 'hover:bg-yellow-800',

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-orange-100'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass('bg-white'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-white'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-white'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-yellow-400'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-yellow-400'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-yellow-400'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass('bg-yellow-50'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
          'mocha': {
            name: 'Mocha',
            bgScreen: 'bg-[#D58936]',
            bgContainer: `bg-[${shadeColor('#D58936', 0.1)}]`,
            borderContainer: `border-[${shadeColor('#D58936', -0.2)}]`,
            textAccent: `text-[${shadeColor('#502419', 0.2)}]`,
            textSuccess: 'text-green-600',
            bgInput: `bg-[${shadeColor('#D58936', 0.4)}]`,
            borderInput: `border-[${shadeColor('#D58936', -0.1)}]`,
            focusBorderInput: 'focus:border-[#502419]',
            focusRingInput: 'focus:ring-[#502419]',
            bgSection: `bg-[${shadeColor('#D58936', 0.05)}]`,
            borderSection: `border-[${shadeColor('#D58936', -0.15)}]`,
            bgButtonAdd: 'bg-[#502419]',
            hoverBgButtonAdd: `hover:hover:bg-[${shadeColor('#502419', -0.15)}]`,
            focusRingButtonAdd: `focus:ring-[${shadeColor('#502419', 0.15)}]`,
            bgButtonPrimary: 'bg-[#502419]',
            hoverBgButtonPrimary: `hover:bg-[${shadeColor('#502419', -0.15)}]`,
            focusRingButtonPrimary: `focus:ring-[${shadeColor('#502419', 0.15)}]`,
            bgMessage: `bg-[${shadeColor('#D58936', 0.1)}]`,
            bgResult: `bg-[${shadeColor('#D58936', 0.1)}]`,
            borderResult: `border-[${shadeColor('#D58936', -0.15)}]`,
            bgGoalItem: `bg-[${shadeColor('#D58936', 0.08)}]`,
            borderGoalItem: `border-[${shadeColor('#D58936', -0.12)}]`,
            textDeleteButton: 'text-red-500',
            hoverTextDeleteButton: 'hover:text-red-700',
            bgSubNavActive: `bg-[${shadeColor('#502419', -0.25)}]`,
            bgSubNavInactive: `bg-[${shadeColor('#502419', 0.1)}]`,
            hoverBgSubNav: `hover:bg-[${shadeColor('#502419', -0.35)}]`,

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-[#D58936]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass(shadeColor('#D58936', 0.1)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass(shadeColor('#D58936', 0.4)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass(shadeColor('#D58936', 0.4)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-[#502419]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-[#502419]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-[#502419]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass(shadeColor('#D58936', 0.1)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
          'teal-delight': {
            name: 'Teal Delight',
            bgScreen: 'bg-[#85FFC7]',
            bgContainer: `bg-[${shadeColor('#85FFC7', 0.1)}]`,
            borderContainer: `border-[${shadeColor('#85FFC7', -0.2)}]`,
            textAccent: `text-[${shadeColor('#297373', 0.2)}]`,
            textSuccess: 'text-green-600',
            bgInput: `bg-[${shadeColor('#85FFC7', 0.4)}]`,
            borderInput: `border-[${shadeColor('#85FFC7', -0.1)}]`,
            focusBorderInput: 'focus:border-[#297373]',
            focusRingInput: 'focus:ring-[#297373]',
            bgSection: `bg-[${shadeColor('#85FFC7', 0.05)}]`,
            borderSection: `border-[${shadeColor('#85FFC7', -0.15)}]`,
            bgButtonAdd: 'bg-[#297373]',
            hoverBgButtonAdd: `hover:bg-[${shadeColor('#297373', -0.15)}]`,
            focusRingButtonAdd: `focus:ring-[${shadeColor('#297373', 0.15)}]`,
            bgButtonPrimary: 'bg-[#297373]',
            hoverBgButtonPrimary: `hover:bg-[${shadeColor('#297373', -0.15)}]`,
            focusRingButtonPrimary: `focus:ring-[${shadeColor('#297373', 0.15)}]`,
            bgMessage: `bg-[${shadeColor('#85FFC7', 0.1)}]`,
            bgResult: `bg-[${shadeColor('#85FFC7', 0.1)}]`,
            borderResult: `border-[${shadeColor('#85FFC7', -0.15)}]`,
            bgGoalItem: `bg-[${shadeColor('#85FFC7', 0.08)}]`,
            borderGoalItem: `border-[${shadeColor('#85FFC7', -0.12)}]`,
            textDeleteButton: 'text-red-500',
            hoverTextDeleteButton: 'hover:text-red-700',
            bgSubNavActive: `bg-[${shadeColor('#297373', -0.25)}]`,
            bgSubNavInactive: `bg-[${shadeColor('#297373', 0.1)}]`,
            hoverBgSubNav: `hover:bg-[${shadeColor('#297373', -0.35)}]`,

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-[#85FFC7]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass(shadeColor('#85FFC7', 0.1)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass(shadeColor('#85FFC7', 0.4)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass(shadeColor('#85FFC7', 0.4)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-[#297373]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-[#297373]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-[#297373]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass(shadeColor('#85FFC7', 0.1)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
          'Pink Dayz': {
            name: 'Pink Dayz',
            bgScreen: 'bg-[#E2A3C7]',
            bgContainer: `bg-[${shadeColor('#E2A3C7', -0.1)}]`,
            borderContainer: `border-[${shadeColor('#E2A3C7', -0.3)}]`,
            textAccent: `text-[${getHexFromTailwindClass('DAC0CF')}]`,
            textSuccess: 'text-green-600',
            bgInput: 'bg-[#E6DAE1]',
            borderInput: `border-[${shadeColor('#E6DAE1', -0.2)}]`,
            focusBorderInput: 'focus:border-[#60435F]',
            focusRingInput: 'focus:ring-[#60435F]',
            bgSection: `bg-[${shadeColor('#E2A3C7', -0.05)}]`,
            borderSection: `border-[${shadeColor('#E2A3C7', -0.25)}]`,
            bgButtonAdd: 'bg-[#60435F]',
            hoverBgButtonAdd: `hover:bg-[${shadeColor('#60435F', -0.15)}]`,
            focusRingButtonAdd: `focus:ring-[${shadeColor('#60435F', 0.15)}]`,
            bgButtonPrimary: 'bg-[#60435F]',
            hoverBgButtonPrimary: `hover:bg-[${shadeColor('#60435F', -0.15)}]`,
            focusRingButtonPrimary: `focus:ring-[${shadeColor('#60435F', 0.15)}]`,
            bgMessage: `bg-[${shadeColor('#E2A3C7', -0.1)}]`,
            bgResult: `bg-[${shadeColor('#E2A3C7', -0.1)}]`,
            borderResult: `border-[${shadeColor('#E2A3C7', -0.25)}]`,
            bgGoalItem: `bg-[${shadeColor('#E2A3C7', -0.08)}]`,
            borderGoalItem: `border-[${shadeColor('#E2A3C7', -0.12)}]`,
            textDeleteButton: 'text-red-500',
            hoverTextDeleteButton: 'hover:text-red-700',
            bgSubNavActive: `bg-[${shadeColor('#60435F', -0.25)}]`,
            bgSubNavInactive: `bg-[${shadeColor('#60435F', 0.1)}]`,
            hoverBgSubNav: `hover:bg-[${shadeColor('#60435F', -0.35)}]`,

            // Derived text colors
            textPrimary: getContrastTextColor(getHexFromTailwindClass('bg-[#E2A3C7]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textSecondary: getContrastTextColor(getHexFromTailwindClass(shadeColor('#E2A3C7', -0.1)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-[#E6DAE1]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            placeholderInput: getSpecialInputTextColor(getHexFromTailwindClass('bg-[#E6DAE1]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonPrimary: getContrastTextColor(getHexFromTailwindClass('bg-[#60435F]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textButtonAdd: getContrastTextColor(getHexFromTailwindClass('bg-[#60435F]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            bannerText: getContrastTextColor(getHexFromTailwindClass('bg-[#60435F]'), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
            textMessage: getContrastTextColor(getHexFromTailwindClass(shadeColor('#E2A3C7', -0.1)), tailwindColorsHex['light-global-text'], tailwindColorsHex['dark-global-text']),
          },
        };


        // Modal Component for adding/editing pets
        const AddEditPetModal = ({ isOpen, onClose, onSave, initialPetData, speciesList, patternMap, themeClasses, allPets }) => {
          // Initialize with empty strings for optional fields, or existing data
          const [name, setName] = useState(initialPetData?.name || '');
          const [species, setSpecies] = useState(initialPetData?.species || ''); // Now optional
          const [pattern, setPattern] = useState(initialPetData?.pattern || ''); // Now optional
          const [gender, setGender] = useState(initialPetData?.gender || 'Unknown');
          const [notes, setNotes] = useState(initialPetData?.notes || '');
          const [parent1Id, setParent1Id] = useState(initialPetData?.parents?.[0] || '');
          const [parent2Id, setParent2Id] = useState(initialPetData?.parents?.[1] || '');
          // New states for imageLink and petNumber
          const [imageLink, setImageLink] = useState(initialPetData?.imageLink || '');
          const [petNumber, setPetNumber] = useState(initialPetData?.petNumber || '');
          const [errorMessage, setErrorMessage] = useState('');

          // Update form fields when initialPetData changes (for editing)
          useEffect(() => {
            if (initialPetData) {
              setName(initialPetData.name || '');
              setSpecies(initialPetData.species || '');
              setPattern(initialPetData.pattern || '');
              setGender(initialPetData.gender || 'Unknown');
              setNotes(initialPetData.notes || '');
              setParent1Id(initialPetData.parents?.[0] || '');
              setParent2Id(initialPetData.parents?.[1] || '');
              setImageLink(initialPetData.imageLink || ''); // Update imageLink
              setPetNumber(initialPetData.petNumber || ''); // Update petNumber
            } else {
              // Reset for adding new pet - explicitly set optional fields to empty/default
              setName('');
              setSpecies('');
              setPattern('');
              setGender('Unknown');
              setNotes('');
              setParent1Id('');
              setParent2Id('');
              setImageLink(''); // Reset imageLink
              setPetNumber(''); // Reset petNumber
            }
            setErrorMessage(''); // Clear error message on modal open/data change
          }, [initialPetData]);

          // Set default species when speciesList loads or changes
          // This logic is fine, it just pre-selects the first species if available, but the user can still choose "Select Species"
          useEffect(() => {
            if (!species && speciesList.length > 0) {
              // Only set if species is currently empty and a list exists
              // setSpecies(speciesList[0]); // Removed to truly make species optional by default
            }
          }, [speciesList, species]);

          // Filter patterns based on selected species
          const availablePatterns = patternMap[species] || [];

          const handleSubmit = () => {
            // Only name is required now
            if (!name.trim()) {
              setErrorMessage('Pet Name is required.');
              return;
            }

            // Basic validation for parents to avoid self-parenting or duplicate parents
            if (parent1Id && parent1Id === (initialPetData?.id || '')) {
                setErrorMessage("A pet cannot be its own parent.");
                return;
            }
            if (parent2Id && parent2Id === (initialPetData?.id || '')) {
                setErrorMessage("A pet cannot be its own parent.");
                return;
            }
            if (parent1Id && parent1Id === parent2Id) {
                setErrorMessage("Cannot select the same pet as both parents.");
                return;
            }

            const newPet = {
              id: initialPetData?.id || Date.now().toString(), // Use existing ID or generate new
              name: name.trim(),
              species: species, // Now optional
              pattern: pattern, // Now optional
              gender: gender,
              notes: notes.trim(),
              parents: [parent1Id, parent2Id].filter(id => id), // Filter out empty strings
              offspring: initialPetData?.offspring || [], // Preserve existing offspring
              imageLink: imageLink.trim(), // Include imageLink
              petNumber: petNumber.trim(), // Include petNumber
            };
            onSave(newPet);
            // onClose() is called by onSave to allow for error messages to remain if save fails
          };

          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              {/* Modal Card - now has max-height and is a flex container for its children */}
              <div className={`${themeClasses.bgContainer} p-6 rounded-lg shadow-xl max-w-md w-full relative ${themeClasses.borderContainer} border max-h-[90vh] overflow-hidden flex flex-col`}>
                <h3 className={`text-2xl font-bold mb-4 ${themeClasses.textPrimary} atomic-age-heading`}>
                  {initialPetData ? 'Edit Pet' : 'Add New Pet'}
                </h3>
                {errorMessage && (
                  <p className="text-red-500 text-sm mb-3">{errorMessage}</p>
                )}
                {/* Scrollable form content - takes available space */}
                <div className="flex-grow space-y-3 overflow-y-auto pr-2"> {/* Added pr-2 for scrollbar */}
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Name:<span className="text-red-500">*</span></label>
                    <input
                      type="text"
                      value={name}
                      onChange={(e) => setName(e.target.value)}
                      className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                      placeholder="Pet Name"
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Species (Optional):</label>
                    <select
                      value={species}
                      onChange={(e) => {
                        setSpecies(e.target.value);
                        setPattern(''); // Reset pattern when species changes
                      }}
                      className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                    >
                      <option value="">Select Species</option> /* Added empty option for optional */
                      {speciesList.map((s, i) => (
                        <option key={i} value={s}>{s}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Pattern (Optional):</label>
                    <select
                      value={pattern}
                      onChange={(e) => setPattern(e.target.value)}
                      className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                      disabled={!species}
                    >
                      <option value="">Select Pattern</option> /* Added empty option for optional */
                      {availablePatterns.map((p, i) => (
                        <option key={i} value={p}>{p}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Gender (Optional):</label>
                    <select
                      value={gender}
                      onChange={(e) => setGender(e.target.value)}
                      className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                    >
                      <option value="Unknown">Unknown</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                    </select>
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Image Link (Optional):</label>
                    <input
                      type="text"
                      value={imageLink}
                      onChange={(e) => setImageLink(e.target.value)}
                      className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                      placeholder="e.g., https://example.com/pet.png"
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Pet Number (Optional):</label>
                    <input
                      type="text"
                      value={petNumber}
                      onChange={(e) => setPetNumber(e.target.value)}
                      className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                      placeholder="e.g., #12345"
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Parent 1 (Optional):</label>
                    <select
                        value={parent1Id}
                        onChange={(e) => setParent1Id(e.target.value)}
                        className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                    >
                        <option value="">None</option>
                        {allPets.filter(p => p.id !== (initialPetData?.id || '')).map(p => (
                            <option key={p.id} value={p.id}>{p.name} ({p.species})</option>
                        ))}
                    </select>
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Parent 2 (Optional):</label>
                    <select
                        value={parent2Id}
                        onChange={(e) => setParent2Id(e.target.value)}
                        className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                    >
                        <option value="">None</option>
                        {allPets.filter(p => p.id !== (initialPetData?.id || '') && p.id !== parent1Id).map(p => (
                            <option key={p.id} value={p.id}>{p.name} ({p.species})</option>
                        ))}
                    </select>
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Notes:</label>
                    <textarea
                      value={notes}
                      onChange={(e) => setNotes(e.target.value)}
                      className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                      placeholder="Any additional notes about the pet"
                      rows="3"
                    ></textarea>
                  </div>
                </div>
                {/* Buttons - MOVED OUTSIDE SCROLL AREA, but still within the modal card */}
                <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200"> /* Added pt-4 and border-t for separation */
                  <button
                    onClick={onClose}
                    className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} font-bold transition duration-300`}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300`}
                  >
                    {initialPetData ? 'Save Changes' : 'Add Pet'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Modal Component for displaying pet details
        const PetDetailModal = ({ isOpen, onClose, pet, allPets, themeClasses }) => {
          if (!isOpen || !pet) return null;

          const getPetName = (id) => allPets.find(p => p.id === id)?.name || 'Unknown Pet';

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              {/* Added max-h-[90vh] overflow-hidden flex flex-col to the modal card */}
              <div className={`${themeClasses.bgContainer} p-6 rounded-lg shadow-xl max-w-md w-full relative ${themeClasses.borderContainer} border max-h-[90vh] overflow-hidden flex flex-col`}>
                <h3 className={`text-2xl font-bold mb-4 ${themeClasses.textPrimary} atomic-age-heading`}>Pet Details: {pet.name}</h3>
                {/* Added flex-grow overflow-y-auto pr-2 to the content div */}
                <div className="flex-grow space-y-2 text-left overflow-y-auto pr-2">
                  {pet.imageLink && (
                    <div className="flex justify-center mb-4">
                      <img
                        src={pet.imageLink}
                        alt={`Image of ${pet.name}`}
                        className="max-w-full h-auto max-h-48 object-contain rounded-lg shadow-md"
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/150x150/e0e0e0/333333?text=No+Image"; }}
                      />
                    </div>
                  )}
                  <p className={`${themeClasses.textPrimary}`}><strong>Name:</strong> {pet.name}</p>
                  <p className={`${themeClasses.textPrimary}`}><strong>Pet Number:</strong> {pet.petNumber || 'N/A'}</p>
                  <p className={`${themeClasses.textPrimary}`}><strong>Species:</strong> {pet.species || 'N/A'}</p>
                  <p className={`${themeClasses.textPrimary}`}><strong>Pattern:</strong> {pet.pattern || 'N/A'}</p>
                  <p className={`${themeClasses.textPrimary}`}><strong>Gender:</strong> {pet.gender || 'N/A'}</p>
                  <p className={`${themeClasses.textPrimary}`}><strong>Notes:</strong> {pet.notes || 'No notes'}</p>
                  <p className={`${themeClasses.textPrimary}`}>
                    <strong>Parents:</strong>{' '}
                    {pet.parents && pet.parents.length > 0
                      ? pet.parents.map(id => getPetName(id)).join(', ')
                      : 'N/A'}
                  </p>
                  <p className={`${themeClasses.textPrimary}`}>
                    <strong>Offspring:</strong>{' '}
                    {pet.offspring && pet.offspring.length > 0
                      ? pet.offspring.map(id => getPetName(id)).join(', ')
                      : 'N/A'}
                  </p>
                  {pet.imageLink && (
                    <p className={`${themeClasses.textSecondary} text-sm break-all`}><strong>Image Link:</strong> {pet.imageLink}</p>
                  )}
                </div>
                <div className="flex justify-end mt-6">
                  <button
                    onClick={onClose}
                    className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300`}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Modal Component for adding/editing breeding pairs
        const AddEditPairModal = ({ isOpen, onClose, onSave, initialPairData, allPets, themeClasses }) => {
            const [malePetId, setMalePetId] = useState(initialPairData?.malePetId || '');
            const [femalePetId, setFemalePetId] = useState(initialPairData?.femalePetId || '');
            const [pairingDate, setPairingDate] = useState(initialPairData?.pairingDate || '');
            const [notes, setNotes] = useState(initialPairData?.notes || '');
            const [errorMessage, setErrorMessage] = useState('');

            useEffect(() => {
                if (initialPairData) {
                    setMalePetId(initialPairData.malePetId || '');
                    setFemalePetId(initialPairData.femalePetId || '');
                    setPairingDate(initialPairData.pairingDate || '');
                    setNotes(initialPairData.notes || '');
                } else {
                    setMalePetId('');
                    setFemalePetId('');
                    setPairingDate('');
                    setNotes('');
                }
                setErrorMessage('');
            }, [initialPairData]);

            const handleSubmit = () => {
                if (!malePetId || !femalePetId || !pairingDate) {
                    setErrorMessage('Both pets and pairing date are required.');
                    return;
                }
                if (malePetId === femalePetId) {
                    setErrorMessage('Cannot pair a pet with itself.');
                    return;
                }

                const malePet = allPets.find(p => p.id === malePetId);
                const femalePet = allPets.find(p => p.id === femalePetId);

                if (malePet?.gender !== 'Male' || femalePet?.gender !== 'Female') {
                    setErrorMessage('Please select a male and a female pet for the pair.');
                    return;
                }

                const newPair = {
                    id: initialPairData?.id || Date.now().toString(),
                    malePetId,
                    femalePetId,
                    pairingDate,
                    notes: notes.trim(),
                };
                onSave(newPair);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`${themeClasses.bgContainer} p-6 rounded-lg shadow-xl max-w-md w-full relative ${themeClasses.borderContainer} border`}>
                        <h3 className={`text-2xl font-bold mb-4 ${themeClasses.textPrimary} atomic-age-heading`}>
                            {initialPairData ? 'Edit Breeding Pair' : 'Add New Breeding Pair'}
                        </h3>
                        {errorMessage && (
                            <p className="text-red-500 text-sm mb-3">{errorMessage}</p>
                        )}
                        <div className="space-y-3">
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Male Pet:</label>
                                <select
                                    value={malePetId}
                                    onChange={(e) => setMalePetId(e.target.value)}
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                                >
                                    <option value="">Select Male Pet</option>
                                    {allPets.filter(p => p.gender === 'Male').map(p => (
                                        <option key={p.id} value={p.id}>{p.name} ({p.species})</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Female Pet:</label>
                                <select
                                    value={femalePetId}
                                    onChange={(e) => setFemalePetId(e.target.value)}
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                                >
                                    <option value="">Select Female Pet</option>
                                    {allPets.filter(p => p.gender === 'Female').map(p => (
                                        <option key={p.id} value={p.id}>{p.name} ({p.species})</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Pairing Date:</label>
                                <input
                                    type="date"
                                    value={pairingDate}
                                    onChange={(e) => setPairingDate(e.target.value)}
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                                />
                            </div>
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Notes:</label>
                                <textarea
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                                    placeholder="Any additional notes about the pair"
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} font-bold transition duration-300`}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSubmit}
                                className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300`}
                            >
                                {initialPairData ? 'Save Changes' : 'Add Pair'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Modal Component for displaying breeding pair details
        const PairDetailModal = ({ isOpen, onClose, pair, allPets, themeClasses }) => {
            if (!isOpen || !pair) return null;

            const getPetName = (id) => allPets.find(p => p.id === id)?.name || 'Unknown Pet';
            const getPetSpecies = (id) => allPets.find(p => p.id === id)?.species || 'Unknown Species';

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`${themeClasses.bgContainer} p-6 rounded-lg shadow-xl max-w-md w-full relative ${themeClasses.borderContainer} border`}>
                        <h3 className={`text-2xl font-bold mb-4 ${themeClasses.textPrimary} atomic-age-heading`}>Breeding Pair Details</h3>
                        <div className="space-y-2 text-left">
                            <p className={`${themeClasses.textPrimary}`}><strong>Male:</strong> {getPetName(pair.malePetId)} ({getPetSpecies(pair.malePetId)})</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Female:</strong> {getPetName(pair.femalePetId)} ({getPetSpecies(pair.femalePetId)})</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Pairing Date:</strong> {pair.pairingDate}</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Notes:</strong> {pair.notes || 'No notes'}</p>
                        </div>
                        <div className="flex justify-end mt-6">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300`}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Modal for adding/editing a project
        const AddEditProjectModal = ({ isOpen, onClose, onSave, initialProjectData, speciesList, patternMap, themeClasses }) => {
            const [starterPairs, setStarterPairs] = useState(initialProjectData?.starterPairs || 1);
            const [species, setSpecies] = useState(initialProjectData?.species || '');
            const [pattern, setPattern] = useState(initialProjectData?.pattern || '');
            const [notes, setNotes] = useState(initialProjectData?.notes || '');
            const [checklist, setChecklist] = useState(initialProjectData?.checklist || [{ id: Date.now().toString(), text: '', completed: false }]);
            const [errorMessage, setErrorMessage] = useState('');

            useEffect(() => {
                if (initialProjectData) {
                    setStarterPairs(initialProjectData.starterPairs || 1);
                    setSpecies(initialProjectData.species || '');
                    setPattern(initialProjectData.pattern || '');
                    setNotes(initialProjectData.notes || '');
                    setChecklist(initialProjectData.checklist || [{ id: Date.now().toString(), text: '', completed: false }]);
                } else {
                    setStarterPairs(1);
                    setSpecies('');
                    setPattern('');
                    setNotes('');
                    setChecklist([{ id: Date.now().toString(), text: '', completed: false }]);
                }
                setErrorMessage('');
            }, [initialProjectData]);

            useEffect(() => {
                if (!species && speciesList.length > 0) {
                    setSpecies(speciesList[0]);
                }
            }, [speciesList, species]);

            const availablePatterns = patternMap[species] || [];

            const handleAddChecklistItem = () => {
                setChecklist(prev => [...prev, { id: Date.now().toString(), text: '', completed: false }]);
            };

            const handleChecklistItemChange = (id, newText) => {
                setChecklist(prev => prev.map(item => item.id === id ? { ...item, text: newText } : item));
            };

            const handleToggleChecklistItem = (id) => {
                setChecklist(prev => prev.map(item => item.id === id ? { ...item, completed: !item.completed } : item));
            };

            const handleRemoveChecklistItem = (id) => {
                setChecklist(prev => prev.filter(item => item.id !== id));
            };

            const handleSubmit = () => {
                if (!species.trim()) {
                    setErrorMessage('Species is required.');
                    return;
                }
                if (starterPairs <= 0) {
                    setErrorMessage('Number of starter pairs must be at least 1.');
                    return;
                }

                const newProject = {
                    id: initialProjectData?.id || Date.now().toString(),
                    starterPairs: parseInt(starterPairs),
                    species: species,
                    pattern: pattern,
                    notes: notes.trim(),
                    checklist: checklist.filter(item => item.text.trim() !== ''), // Filter out empty checklist items
                    dateAdded: initialProjectData?.dateAdded || new Date().toLocaleDateString(),
                    lastUpdated: new Date().toLocaleDateString(),
                };
                onSave(newProject);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    {/* Modal Card - now has max-height and is a flex container for its children */}
                    <div className={`${themeClasses.bgContainer} p-6 rounded-lg shadow-xl max-w-md w-full relative ${themeClasses.borderContainer} border max-h-[90vh] overflow-hidden flex flex-col`}>
                        <h3 className={`text-2xl font-bold mb-4 ${themeClasses.textPrimary} atomic-age-heading`}>
                            {initialProjectData ? 'Edit Project' : 'Add New Project'}
                        </h3>
                        {errorMessage && (
                            <p className="text-red-500 text-sm mb-3">{errorMessage}</p>
                        )}
                        {/* Scrollable form content - takes available space */}
                        <div className="flex-grow space-y-3 overflow-y-auto pr-2">
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Number of Starter Pairs:</label>
                                <input
                                    type="number"
                                    value={starterPairs}
                                    onChange={(e) => setStarterPairs(e.target.value)}
                                    min="1"
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                                />
                            </div>
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Species:</label>
                                <select
                                    value={species}
                                    onChange={(e) => {
                                        setSpecies(e.target.value);
                                        setPattern('');
                                    }}
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                                >
                                    <option value="">Select Species</option>
                                    {speciesList.map((s, i) => (
                                        <option key={i} value={s}>{s}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Pattern (Optional):</label>
                                <select
                                    value={pattern}
                                    onChange={(e) => setPattern(e.target.value)}
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                                    disabled={!species}
                                >
                                    <option value="">Select Pattern</option>
                                    {availablePatterns.map((p, i) => (
                                        <option key={i} value={p}>{p}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Notes/Goals:</label>
                                <textarea
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    className={`w-full p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                                    placeholder="Goals for this project, e.g., 'Breed for triple mutations'"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div>
                                <label className={`block text-sm font-semibold mb-1 ${themeClasses.textPrimary}`}>Custom Checklist:</label>
                                <div className="space-y-2">
                                    {checklist.map((item, index) => (
                                        <div key={item.id} className="flex items-center gap-2">
                                            <input
                                                type="checkbox"
                                                checked={item.completed}
                                                onChange={() => handleToggleChecklistItem(item.id)}
                                                className="form-checkbox h-5 w-5 text-blue-600 rounded"
                                            />
                                            <input
                                                type="text"
                                                value={item.text}
                                                onChange={(e) => handleChecklistItemChange(item.id, e.target.value)}
                                                placeholder={`Checklist item ${index + 1}`}
                                                className={`flex-grow p-2 rounded-md ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                                            />
                                            <button
                                                onClick={() => handleRemoveChecklistItem(item.id)}
                                                className={`${themeClasses.textDeleteButton} hover:${themeClasses.hoverTextDeleteButton} text-sm`}
                                                aria-label="Remove checklist item"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clipRule="evenodd" />
                                                </svg>
                                            </button>
                                        </div>
                                    ))}
                                    <button
                                        onClick={handleAddChecklistItem}
                                        className={`mt-2 px-3 py-1 text-sm rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} font-bold transition duration-300`}
                                    >
                                        Add Checklist Item
                                    </button>
                                </div>
                            </div>
                        </div>
                        {/* Buttons - MOVED OUTSIDE SCROLL AREA, but still within the modal card */}
                        <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} font-bold transition duration-300`}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSubmit}
                                className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300`}
                            >
                                {initialProjectData ? 'Save Changes' : 'Add Project'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Modal for displaying project details
        const ProjectDetailModal = ({ isOpen, onClose, project, themeClasses }) => {
            if (!isOpen || !project) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`${themeClasses.bgContainer} p-6 rounded-lg shadow-xl max-w-md w-full relative ${themeClasses.borderContainer} border`}>
                        <h3 className={`text-2xl font-bold mb-4 ${themeClasses.textPrimary} atomic-age-heading`}>Project Details</h3>
                        <div className="space-y-2 text-left">
                            <p className={`${themeClasses.textPrimary}`}><strong>Starter Pairs:</strong> {project.starterPairs}</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Species:</strong> {project.species}</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Pattern:</strong> {project.pattern || 'N/A'}</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Notes/Goals:</strong> {project.notes || 'No notes'}</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Date Added:</strong> {project.dateAdded}</p>
                            <p className={`${themeClasses.textPrimary}`}><strong>Last Updated:</strong> {project.lastUpdated}</p>
                            <p className={`${themeClasses.textPrimary} mt-3`}><strong>Checklist:</strong></p>
                            {project.checklist && project.checklist.length > 0 ? (
                                <ul className="list-inside space-y-1 ml-4">
                                    {project.checklist.map(item => (
                                        <li key={item.id} className={`${themeClasses.textPrimary} ${item.completed ? 'line-through text-gray-500' : ''}`}>
                                            {item.text}
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className={`${themeClasses.textSecondary} text-sm ml-4`}>No checklist items.</p>
                            )}
                        </div>
                        <div className="flex justify-end mt-6">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300`}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // Generic Confirmation Modal
        const ConfirmDeleteModal = ({ isOpen, onClose, onConfirm, message, themeClasses }) => {
          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className={`${themeClasses.bgContainer} p-6 rounded-lg shadow-xl max-w-sm w-full relative ${themeClasses.borderContainer} border`}>
                <h3 className={`text-xl font-bold mb-4 ${themeClasses.textPrimary} atomic-age-heading`}>Confirm Deletion</h3>
                <p className={`${themeClasses.textSecondary} mb-6`}>{message}</p>
                <div className="flex justify-end gap-3">
                  <button
                    onClick={onClose}
                    className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} font-bold transition duration-300`}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={onConfirm}
                    className={`px-4 py-2 rounded-lg bg-red-500 hover:bg-red-700 text-white font-bold transition duration-300`}
                  >
                    Delete
                  </button>
                </div>
              </div>
            </div>
          );
        };


        // Component for the Breeding Projects content
        const BreedingProjectsContent = ({ themeClasses, currentSubPage, setCurrentSubPage }) => {
          const LOCAL_STORAGE_SPECIES_KEY = 'breedingTrackerSpecies';
          const LOCAL_STORAGE_PATTERNS_KEY = 'breedingTrackerPatterns';
          const LOCAL_STORAGE_PETS_KEY = 'breedingTrackerPets'; // New key for pets
          const LOCAL_STORAGE_BREEDING_PAIRS_KEY = 'breedingTrackerBreedingPairs'; // New key for breeding pairs
          const LOCAL_STORAGE_PROJECTS_KEY = 'breedingTrackerProjects'; // New key for projects

          const [speciesList, setSpeciesList] = useState([]);
          const [patternMap, setPatternMap] = useState({});
          const [pets, setPets] = useState([]); // New state for pets
          const [breedingPairs, setBreedingPairs] = useState([]); // New state for breeding pairs
          const [projects, setProjects] = useState([]); // New state for projects
          const [newSpeciesName, setNewSpeciesName] = useState('');
          const [newPatternName, setNewPatternName] = useState('');
          const [selectedSpeciesForPattern, setSelectedSpeciesForPattern] = useState('');
          const [settingsMessage, setSettingsMessage] = useState('');
          const [relationsMessage, setRelationsMessage] = useState(''); // Message for relations tab
          const [breedingPairsMessage, setBreedingPairsMessage] = useState(''); // Message for breeding pairs tab
          const [projectLogMessage, setProjectLogMessage] = useState(''); // Message for project log tab
          const [petsMessage, setPetsMessage] = useState(''); // Message for pets tab (formerly offspring)

          // Modals state for Pets tab (formerly Relations)
          const [isAddEditPetModalOpen, setIsAddEditPetModalOpen] = useState(false);
          const [selectedPet, setSelectedPet] = useState(null); // For editing or viewing details
          const [isPetDetailModalOpen, setIsPetDetailModalOpen] = useState(false);
          const [isConfirmDeletePetModalOpen, setIsConfirmDeletePetModalOpen] = useState(false); // Renamed for clarity
          const [petToDelete, setPetToDelete] = useState(null); // Pet object to be deleted

          // Modals state for Breeding Pairs tab
          const [isAddEditPairModalOpen, setIsAddEditPairModal] = useState(false);
          const [selectedPair, setSelectedPair] = useState(null); // For editing or viewing details
          const [isPairDetailModalOpen, setIsPairDetailModalOpen] = useState(false);
          const [isConfirmDeletePairModalOpen, setIsConfirmDeletePairModalOpen] = useState(false);
          const [pairToDelete, setPairToDelete] = useState(null); // Pair object to be deleted

          // Modals state for Project Log tab
          const [isAddEditProjectModalOpen, setIsAddEditProjectModalOpen] = useState(false);
          const [selectedProject, setSelectedProject] = useState(null); // For editing or viewing details
          const [isProjectDetailModalOpen, setIsProjectDetailModalOpen] = useState(false);
          const [isConfirmDeleteProjectModalOpen, setIsConfirmDeleteProjectModalOpen] = useState(false);
          const [projectToDelete, setProjectToDelete] = useState(null); // Project object to be deleted


          // Load data from local storage
          useEffect(() => {
            try {
              const storedSpecies = localStorage.getItem(LOCAL_STORAGE_SPECIES_KEY);
              if (storedSpecies) {
                setSpeciesList(JSON.parse(storedSpecies));
              }
              const storedPatterns = localStorage.getItem(LOCAL_STORAGE_PATTERNS_KEY);
              if (storedPatterns) {
                setPatternMap(JSON.parse(storedPatterns));
              }
              const storedPets = localStorage.getItem(LOCAL_STORAGE_PETS_KEY);
              if (storedPets) {
                setPets(JSON.parse(storedPets));
              }
              const storedBreedingPairs = localStorage.getItem(LOCAL_STORAGE_BREEDING_PAIRS_KEY);
              if (storedBreedingPairs) {
                setBreedingPairs(JSON.parse(storedBreedingPairs));
              }
              const storedProjects = localStorage.getItem(LOCAL_STORAGE_PROJECTS_KEY);
              if (storedProjects) {
                setProjects(JSON.parse(storedProjects));
              }
            } catch (error) {
              console.error("Failed to load breeding data from local storage:", error);
              setSettingsMessage("Error loading saved breeding data. Local storage might be full or corrupted.");
              setRelationsMessage("Error loading saved pet data. Local storage might be full or corrupted.");
              setBreedingPairsMessage("Error loading saved breeding pair data. Local storage might be full or corrupted.");
              setProjectLogMessage("Error loading saved project data. Local storage might be full or corrupted.");
              setPetsMessage("Error loading saved pet data. Local storage might be full or corrupted."); // Updated message
            }
          }, []);

          // Save data to local storage whenever state changes
          useEffect(() => {
            try {
              localStorage.setItem(LOCAL_STORAGE_SPECIES_KEY, JSON.stringify(speciesList));
            } catch (error) {
              console.error("Failed to save species to local storage:", error);
              setSettingsMessage("Error saving species. Local storage might be full.");
            }
          }, [speciesList]);

          useEffect(() => {
            try {
              localStorage.setItem(LOCAL_STORAGE_PATTERNS_KEY, JSON.stringify(patternMap));
            } catch (error) {
              console.error("Failed to save patterns to local storage:", error);
              setSettingsMessage("Error saving patterns. Local storage might be full.");
            }
          }, [patternMap]);

          useEffect(() => {
            try {
              localStorage.setItem(LOCAL_STORAGE_PETS_KEY, JSON.stringify(pets));
            } catch (error) {
              console.error("Failed to save pets to local storage:", error);
              setRelationsMessage("Error saving pet data. Local storage might be full.");
              setPetsMessage("Error saving pet data. Local storage might be full."); // Updated message
            }
          }, [pets]);

          useEffect(() => {
            try {
              localStorage.setItem(LOCAL_STORAGE_BREEDING_PAIRS_KEY, JSON.stringify(breedingPairs));
            } catch (error) {
              console.error("Failed to save breeding pairs to local storage:", error);
              setBreedingPairsMessage("Error saving breeding pair data. Local storage might be full.");
            }
          }, [breedingPairs]);

          useEffect(() => {
            try {
              localStorage.setItem(LOCAL_STORAGE_PROJECTS_KEY, JSON.stringify(projects));
            } catch (error) {
              console.error("Failed to save projects to local storage:", error);
              setProjectLogMessage("Error saving project data. Local storage might be full.");
            }
          }, [projects]);


          // Set initial selected species for pattern if species exist
          useEffect(() => {
            if (speciesList.length > 0 && !selectedSpeciesForPattern) {
              setSelectedSpeciesForPattern(speciesList[0]);
            } else if (speciesList.length === 0 && selectedSpeciesForPattern) {
              setSelectedSpeciesForPattern(''); // Clear if no species exist
            }
          }, [speciesList, selectedSpeciesForPattern]);


          // --- Species and Pattern Management Functions ---
          const addSpecies = () => {
            setSettingsMessage('');
            const trimmedName = newSpeciesName.trim();
            if (trimmedName === '') {
              setSettingsMessage('Species name cannot be empty.');
              return;
            }
            if (speciesList.includes(trimmedName)) {
              setSettingsMessage('Species already exists.');
              return;
            }
            setSpeciesList(prev => [...prev, trimmedName]);
            setPatternMap(prev => ({ ...prev, [trimmedName]: prev[trimmedName] || [] })); // Initialize empty array for new species
            setNewSpeciesName('');
            setSettingsMessage(`'${trimmedName}' added to species.`);
            // Automatically select the new species for pattern addition
            setSelectedSpeciesForPattern(trimmedName);
          };

          const addPattern = () => {
            setSettingsMessage('');
            const trimmedPatternName = newPatternName.trim();
            if (selectedSpeciesForPattern === '') {
              setSettingsMessage('Please select a species first.');
              return;
            }
            if (trimmedPatternName === '') {
              setSettingsMessage('Pattern name cannot be empty.');
              return;
            }
            if (patternMap[selectedSpeciesForPattern] && patternMap[selectedSpeciesForPattern].includes(trimmedPatternName)) {
              setSettingsMessage(`Pattern '${trimmedPatternName}' already exists for ${selectedSpeciesForPattern}.`);
              return;
            }

            setPatternMap(prev => ({
              ...prev,
              [selectedSpeciesForPattern]: [...(prev[selectedSpeciesForPattern] || []), trimmedPatternName]
            }));
            setNewPatternName('');
            setSettingsMessage(`'${trimmedPatternName}' added to patterns for ${selectedSpeciesForPattern}.`);
          };

          const deleteSpecies = (speciesToDelete) => {
            setSpeciesList(prev => prev.filter(s => s !== speciesToDelete));
            setPatternMap(prev => {
              const newMap = { ...prev };
              delete newMap[speciesToDelete]; // Remove all patterns associated with this species
              return newMap;
            });
            // Also delete pets of this species
            setPets(prevPets => prevPets.filter(p => p.species !== speciesToDelete));
            // Also delete breeding pairs involving pets of this species
            setBreedingPairs(prevPairs => prevPairs.filter(pair => {
                const malePet = pets.find(p => p.id === pair.malePetId);
                const femalePet = pets.find(p => p.id === pair.femalePetId);
                return malePet?.species !== speciesToDelete && femalePet?.species !== speciesToDelete;
            }));
            // Also delete projects involving this species
            setProjects(prevProjects => prevProjects.filter(p => p.species !== speciesToDelete));

            setSettingsMessage(`'${speciesToDelete}' and its patterns/pets/pairs/projects removed.`);
          };

          const deletePattern = (species, patternToDelete) => {
            setPatternMap(prev => ({
              ...prev,
              [species]: prev[species].filter(p => p !== patternToDelete)
            }));
            // Also update pets that use this pattern
            setPets(prevPets => prevPets.map(p =>
                p.species === species && p.pattern === patternToDelete ? { ...p, pattern: '' } : p
            ));
            // Also update projects that use this pattern
            setProjects(prevProjects => prevProjects.map(p =>
                p.species === species && p.pattern === patternToDelete ? { ...p, pattern: '' } : p
            ));
            setSettingsMessage(`'${patternToDelete}' removed from ${species}.`);
          };

          // --- Pet Management Functions for Pets Tab ---
          const handleAddPet = () => {
            setSelectedPet(null); // Clear any previous selected pet data
            setIsAddEditPetModalOpen(true);
          };

          const handleEditPet = (pet) => {
            setSelectedPet(pet);
            setIsAddEditPetModalOpen(true);
          };

          const handleSavePet = (newPetData) => {
            setPetsMessage(''); // Changed from setRelationsMessage
            // Check for duplicate pet name (case-insensitive, excluding current pet if editing)
            const isDuplicate = pets.some(p =>
                p.name.toLowerCase() === newPetData.name.toLowerCase() && p.id !== newPetData.id
            );
            if (isDuplicate) {
                setPetsMessage(`A pet named '${newPetData.name}' already exists.`); // Changed from setRelationsMessage
                return; // Do not close modal if there's an error
            }

            // Get the old pet data before updating the main pets array
            const oldPetData = pets.find(p => p.id === newPetData.id);

            // Update the pets array with the new/edited pet
            let updatedPets;
            if (oldPetData) {
                // Editing existing pet
                updatedPets = pets.map(p =>
                    p.id === newPetData.id ? { ...p, ...newPetData } : p
                );
                setPetsMessage(`Pet '${newPetData.name}' updated successfully.`); // Changed from setRelationsMessage
            } else {
                // Adding new pet
                updatedPets = [...pets, newPetData];
                setPetsMessage(`Pet '${newPetData.name}' added successfully.`); // Changed from setRelationsMessage
            }

            // Now, manage parent-offspring relationships based on the update
            let finalPets = updatedPets.map(p => {
                // If this pet 'p' is one of the newPetData's parents, ensure newPetData is in its offspring list
                if (newPetData.parents.includes(p.id) && !p.offspring.includes(newPetData.id)) {
                    return { ...p, offspring: [...p.offspring, newPetData.id] };
                }
                // If oldPetData existed and this pet 'p' was a parent of oldPetData,
                // but is no longer a parent in newPetData, remove newPetData's ID from its offspring.
                if (oldPetData && oldPetData.parents.includes(p.id) && !newPetData.parents.includes(p.id)) {
                    return { ...p, offspring: p.offspring.filter(id => id !== newPetData.id) };
                }
                return p;
            });

            setPets(finalPets); // Set the final, relationship-adjusted pets array
            setIsAddEditPetModalOpen(false); // Close modal on successful save
          };


          const handleViewPetDetail = (pet) => {
            setSelectedPet(pet);
            setIsPetDetailModalOpen(true);
          };

          const handleDeletePet = (pet) => {
            setPetToDelete(pet);
            setIsConfirmDeletePetModalOpen(true);
          };

          const confirmDeletePet = () => {
            if (petToDelete) {
              setPets(prevPets => {
                const updatedPets = prevPets.filter(p => p.id !== petToDelete.id);

                // Also remove this pet from any parent/offspring lists of other pets
                const petsAfterOffspringUpdate = updatedPets.map(p => ({
                    ...p,
                    parents: p.parents.filter(id => id !== petToDelete.id),
                    offspring: p.offspring.filter(id => id !== petToDelete.id)
                }));

                return petsAfterOffspringUpdate;
              });

              // Also remove this pet from any breeding pairs
              setBreedingPairs(prevPairs => prevPairs.filter(pair =>
                  pair.malePetId !== petToDelete.id && pair.femalePetId !== petToDelete.id
              ));

              setPetsMessage(`Pet '${petToDelete.name}' deleted successfully.`); // Changed from setRelationsMessage
            }
            setIsConfirmDeletePetModalOpen(false);
            setPetToDelete(null);
          };

          // --- Breeding Pair Management Functions ---
          const handleAddPair = () => {
            setSelectedPair(null);
            setIsAddEditPairModal(true);
          };

          const handleEditPair = (pair) => {
            setSelectedPair(pair);
            setIsAddEditPairModal(true);
          };

          const handleSavePair = (newPairData) => {
            setBreedingPairsMessage('');
            setBreedingPairs(prevPairs => {
              const existingPairIndex = prevPairs.findIndex(pair => pair.id === newPairData.id);
              if (existingPairIndex > -1) {
                setBreedingPairsMessage('Breeding pair updated successfully.');
                return prevPairs.map(pair =>
                  pair.id === newPairData.id ? newPairData : pair
                );
              } else {
                setBreedingPairsMessage('Breeding pair added successfully.');
                return [...prevPairs, newPairData];
              }
            });
            setIsAddEditPairModal(false);
          };

          const handleViewPairDetail = (pair) => {
            setSelectedPair(pair);
            setIsPairDetailModalOpen(true);
          };

          const handleDeletePair = (pair) => {
            setPairToDelete(pair);
            setIsConfirmDeletePairModalOpen(true);
          };

          const confirmDeletePair = () => {
            if (pairToDelete) {
              setBreedingPairs(prevPairs => prevPairs.filter(pair => pair.id !== pairToDelete.id));
              setBreedingPairsMessage('Breeding pair deleted successfully.');
            }
            setIsConfirmDeletePairModalOpen(false);
            setPairToDelete(null);
          };

          // --- Project Log Management Functions ---
          const handleAddProject = () => {
            setSelectedProject(null);
            setIsAddEditProjectModalOpen(true);
          };

          const handleEditProject = (project) => {
            setSelectedProject(project);
            setIsAddEditProjectModalOpen(true);
          };

          const handleSaveProject = (newProjectData) => {
            setProjectLogMessage('');
            setProjects(prevProjects => {
              const existingProjectIndex = prevProjects.findIndex(p => p.id === newProjectData.id);
              if (existingProjectIndex > -1) {
                setProjectLogMessage('Project updated successfully.');
                return prevProjects.map(p =>
                  p.id === newProjectData.id ? newProjectData : p
                );
              } else {
                setProjectLogMessage('Project added successfully.');
                return [...prevProjects, newProjectData];
              }
            });
            setIsAddEditProjectModalOpen(false);
          };

          const handleViewProjectDetail = (project) => {
            setSelectedProject(project);
            setIsProjectDetailModalOpen(true);
          };

          const handleDeleteProject = (project) => {
            setProjectToDelete(project);
            setIsConfirmDeleteProjectModalOpen(true);
          };

          const confirmDeleteProject = () => {
            if (projectToDelete) {
              setProjects(prevProjects => prevProjects.filter(p => p.id !== projectToDelete.id));
              setProjectLogMessage('Project deleted successfully.');
            }
            setIsConfirmDeleteProjectModalOpen(false);
            setProjectToDelete(null);
          };

          // Filter pets that have parents to display as offspring (for Relations tab)
          const offspringList = pets.filter(pet => pet.parents && pet.parents.length > 0);


          return (
            <div className={`${themeClasses.bgContainer} p-6 sm:p-10 rounded-2xl shadow-xl w-full max-w-4xl ${themeClasses.borderContainer} border`}>
              <h2 className={`text-3xl sm:text-4xl font-bold text-center mb-6 ${themeClasses.textPrimary} atomic-age-heading`}>
                Breeding Projects Tracker
              </h2>

              {/* Sub-navigation for Breeding Projects */}
              <div className={`w-full ${themeClasses.bgSection} p-2 rounded-lg shadow-inner mb-6 flex flex-wrap justify-center gap-1 border ${themeClasses.borderSection}`}>
                <button
                  onClick={() => setCurrentSubPage('dashboard')}
                  className={`px-2 py-1 text-xs rounded-full shadow-md transition duration-300 ease-in-out
                    ${currentSubPage === 'dashboard' ? `${themeClasses.bgSubNavActive} ${themeClasses.textPrimary} border-2 border-blue-500` : `${themeClasses.bgSubNavInactive} ${themeClasses.textSecondary} ${themeClasses.hoverBgSubNav}`}
                  `}
                >
                  Dashboard
                </button>
                <button
                  onClick={() => setCurrentSubPage('breedingPairs')}
                  className={`px-2 py-1 text-xs rounded-full shadow-md transition duration-300 ease-in-out
                    ${currentSubPage === 'breedingPairs' ? `${themeClasses.bgSubNavActive} ${themeClasses.textPrimary} border-2 border-blue-500` : `${themeClasses.bgSubNavInactive} ${themeClasses.textSecondary} ${themeClasses.hoverBgSubNav}`}
                  `}
                >
                  Breeding Pairs
                </button>
                <button
                  onClick={() => setCurrentSubPage('pets')}
                  className={`px-2 py-1 text-xs rounded-full shadow-md transition duration-300 ease-in-out
                    ${currentSubPage === 'pets' ? `${themeClasses.bgSubNavActive} ${themeClasses.textPrimary} border-2 border-blue-500` : `${themeClasses.bgSubNavInactive} ${themeClasses.textSecondary} ${themeClasses.hoverBgSubNav}`}
                  `}
                >
                  Pets
                </button>
                <button
                  onClick={() => setCurrentSubPage('relations')}
                  className={`px-2 py-1 text-xs rounded-full shadow-md transition duration-300 ease-in-out
                    ${currentSubPage === 'relations' ? `${themeClasses.bgSubNavActive} ${themeClasses.textPrimary} border-2 border-blue-500` : `${themeClasses.bgSubNavInactive} ${themeClasses.textSecondary} ${themeClasses.hoverBgSubNav}`}
                  `}
                >
                  Relations
                </button>
                <button
                  onClick={() => setCurrentSubPage('projectLog')}
                  className={`px-2 py-1 text-xs rounded-full shadow-md transition duration-300 ease-in-out
                    ${currentSubPage === 'projectLog' ? `${themeClasses.bgSubNavActive} ${themeClasses.textPrimary} border-2 border-blue-500` : `${themeClasses.bgSubNavInactive} ${themeClasses.textSecondary} ${themeClasses.hoverBgSubNav}`}
                  `}
                >
                  Project Log
                </button>
                <button
                  onClick={() => setCurrentSubPage('settings')}
                  className={`px-2 py-1 text-xs rounded-full shadow-md transition duration-300 ease-in-out
                    ${currentSubPage === 'settings' ? `${themeClasses.bgSubNavActive} ${themeClasses.textPrimary} border-2 border-blue-500` : `${themeClasses.bgSubNavInactive} ${themeClasses.textSecondary} ${themeClasses.hoverBgSubNav}`}
                  `}
                >
                  Settings
                </button>
              </div>

              {/* Content area for the selected sub-page */}
              <div className="mt-8 text-center">
                {currentSubPage === 'dashboard' && (
                  <div className="space-y-6">
                    <h3 className={`text-2xl font-semibold ${themeClasses.textPrimary} mb-4 atomic-age-heading`}>Dashboard Overview</h3>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className={`${themeClasses.bgSection} p-4 rounded-lg shadow-inner ${themeClasses.borderSection} border`}>
                            <h4 className={`text-xl font-semibold ${themeClasses.textPrimary}`}>Total Pets</h4>
                            <p className={`text-3xl font-bold ${themeClasses.textAccent}`}>{pets.length}</p>
                        </div>
                        <div className={`${themeClasses.bgSection} p-4 rounded-lg shadow-inner ${themeClasses.borderSection} border`}>
                            <h4 className={`text-xl font-semibold ${themeClasses.textPrimary}`}>Total Breeding Pairs</h4>
                            <p className={`text-3xl font-bold ${themeClasses.textAccent}`}>{breedingPairs.length}</p>
                        </div>
                        <div className={`${themeClasses.bgSection} p-4 rounded-lg shadow-inner ${themeClasses.borderSection} border`}>
                            <h4 className={`text-xl font-semibold ${themeClasses.textPrimary}`}>Total Projects</h4>
                            <p className={`text-3xl font-bold ${themeClasses.textAccent}`}>{projects.length}</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Recent Pets Section */}
                        <div className={`${themeClasses.bgSection} p-4 rounded-lg shadow-inner ${themeClasses.borderSection} border`}>
                            <h4 className={`text-xl font-semibold ${themeClasses.textPrimary} mb-3`}>Recently Added Pets</h4>
                            {pets.length === 0 ? (
                                <p className={`${themeClasses.textSecondary} text-sm`}>No pets added yet.</p>
                            ) : (
                                <ul className="list-disc list-inside text-left space-y-1 max-h-40 overflow-y-auto">
                                    {pets.slice(-5).reverse().map(pet => ( // Show last 5, most recent first
                                        <li key={pet.id} className={`${themeClasses.textPrimary} text-sm`}>
                                            {pet.name} ({pet.species || 'N/A'}) - {pet.gender || 'N/A'}
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>

                        {/* Recent Breeding Pairs Section */}
                        <div className={`${themeClasses.bgSection} p-4 rounded-lg shadow-inner ${themeClasses.borderSection} border`}>
                            <h4 className={`text-xl font-semibold ${themeClasses.textPrimary} mb-3`}>Recently Added Breeding Pairs</h4>
                            {breedingPairs.length === 0 ? (
                                <p className={`${themeClasses.textSecondary} text-sm`}>No breeding pairs added yet.</p>
                            ) : (
                                <ul className="list-disc list-inside text-left space-y-1 max-h-40 overflow-y-auto">
                                    {breedingPairs.slice(-5).reverse().map(pair => { // Show last 5, most recent first
                                        const malePet = pets.find(p => p.id === pair.malePetId);
                                        const femalePet = pets.find(p => p.id === pair.femalePetId);
                                        return (
                                            <li key={pair.id} className={`${themeClasses.textPrimary} text-sm`}>
                                                {malePet?.name || 'Unknown'} & {femalePet?.name || 'Unknown'} (Paired: {pair.pairingDate})
                                            </li>
                                        );
                                    })}
                                </ul>
                            )}
                        </div>
                    </div>
                  </div>
                )}
                {currentSubPage === 'breedingPairs' && (
                  <div className="space-y-6">
                    <h3 className={`text-2xl font-semibold ${themeClasses.textPrimary} mb-4 atomic-age-heading`}>Manage Breeding Pairs</h3>

                    {breedingPairsMessage && (
                      <p className={`text-center text-sm mb-4 p-2 rounded-lg ${themeClasses.bgMessage} ${themeClasses.textMessage}`}>
                        {breedingPairsMessage}
                      </p>
                    )}

                    <button
                      onClick={handleAddPair}
                      className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300 ease-in-out focus:outline-none focus:ring-2 ${themeClasses.focusRingButtonPrimary} focus:ring-opacity-75 mb-6`}
                    >
                      Add New Breeding Pair
                    </button>

                    {breedingPairs.length === 0 ? (
                      <p className={`${themeClasses.textSecondary} text-lg`}>No breeding pairs added yet.</p>
                    ) : (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-2 rounded-lg border">
                        {breedingPairs.map(pair => {
                          const malePet = pets.find(p => p.id === pair.malePetId);
                          const femalePet = pets.find(p => p.id === pair.femalePetId);
                          return (
                            <div key={pair.id} className={`${themeClasses.bgGoalItem} p-4 rounded-lg shadow-md ${themeClasses.borderGoalItem} border text-left relative`}>
                              <h4 className={`font-bold text-lg ${themeClasses.textPrimary}`}>
                                {malePet?.name || 'Unknown Male'} & {femalePet?.name || 'Unknown Female'}
                              </h4>
                              <p className={`${themeClasses.textSecondary} text-sm`}>
                                Species: {malePet?.species || 'N/A'} & {femalePet?.species || 'N/A'}
                              </p>
                              <p className={`${themeClasses.textSecondary} text-sm`}>
                                Pairing Date: {pair.pairingDate}
                              </p>
                              <div className="flex justify-end gap-2 mt-3">
                                <button
                                  onClick={() => handleViewPairDetail(pair)}
                                  className={`px-3 py-1 text-sm rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} transition-colors`}
                                >
                                  View
                                </button>
                                <button
                                  onClick={() => handleEditPair(pair)}
                                  className={`px-3 py-1 text-sm rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} transition-colors`}
                                >
                                  Edit
                                </button>
                                <button
                                  onClick={() => handleDeletePair(pair)}
                                  className={`px-3 py-1 text-sm rounded-lg bg-red-500 hover:bg-red-700 text-white transition-colors`}
                                >
                                  Delete
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}

                    <AddEditPairModal
                      isOpen={isAddEditPairModal}
                      onClose={() => setIsAddEditPairModal(false)}
                      onSave={handleSavePair}
                      initialPairData={selectedPair}
                      allPets={pets}
                      themeClasses={themeClasses}
                    />

                    <PairDetailModal
                      isOpen={isPairDetailModalOpen}
                      onClose={() => setIsPairDetailModalOpen(false)}
                      pair={selectedPair}
                      allPets={pets}
                      themeClasses={themeClasses}
                    />

                    <ConfirmDeleteModal
                      isOpen={isConfirmDeletePairModalOpen}
                      onClose={() => setIsConfirmDeletePairModalOpen(false)}
                      onConfirm={confirmDeletePair}
                      message={`Are you sure you want to delete this breeding pair? This action cannot be undone.`}
                      themeClasses={themeClasses}
                    />
                  </div>
                )}
                {currentSubPage === 'pets' && (
                  <div className="space-y-6">
                    <h3 className={`text-2xl font-semibold ${themeClasses.textPrimary} mb-4 atomic-age-heading`}>Manage Pets</h3>

                    {petsMessage && (
                      <p className={`text-center text-sm mb-4 p-2 rounded-lg ${themeClasses.bgMessage} ${themeClasses.textMessage}`}>
                        {petsMessage}
                      </p>
                    )}

                    <button
                      onClick={handleAddPet}
                      className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300 ease-in-out focus:outline-none focus:ring-2 ${themeClasses.focusRingButtonPrimary} focus:ring-opacity-75 mb-6`}
                    >
                      Add New Pet
                    </button>

                    {pets.length === 0 ? (
                      <p className={`${themeClasses.textSecondary} text-lg`}>No pets added yet. Click "Add New Pet" to get started!</p>
                    ) : (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 max-h-[40rem] overflow-y-auto p-2 rounded-lg border">
                        {pets.map(pet => (
                          <div key={pet.id} className={`${themeClasses.bgGoalItem} p-2 rounded-lg shadow-md ${themeClasses.borderGoalItem} border text-left relative`}>
                            {pet.imageLink && (
                                <div className="flex justify-center mb-2">
                                  <img
                                    src={pet.imageLink}
                                    alt={`Image of ${pet.name}`}
                                    className="max-w-full h-auto max-h-16 object-contain rounded-lg"
                                    onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/80x80/e0e0e0/333333?text=No+Image"; }}
                                  />
                                </div>
                            )}
                            <h4 className={`font-bold text-md ${themeClasses.textPrimary}`}>{pet.name}</h4>
                            {pet.petNumber && <p className={`${themeClasses.textSecondary} text-xs`}>ID: {pet.petNumber}</p>}
                            <p className={`${themeClasses.textSecondary} text-xs`}>Species: {pet.species || 'N/A'} - {pet.pattern || 'No Pattern'}</p>
                            <p className={`${themeClasses.textSecondary} text-xs`}>Gender: {pet.gender || 'N/A'}</p>
                            <div className="flex justify-end gap-1 mt-2">
                              <button
                                onClick={() => handleViewPetDetail(pet)}
                                className={`px-2 py-1 text-xs rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} transition-colors`}
                              >
                                View
                              </button>
                              <button
                                onClick={() => handleEditPet(pet)}
                                className={`px-2 py-1 text-xs rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} transition-colors`}
                              >
                                Edit
                              </button>
                              <button
                                onClick={() => handleDeletePet(pet)}
                                className={`px-2 py-1 text-xs rounded-lg bg-red-500 hover:bg-red-700 text-white transition-colors`}
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}

                    <AddEditPetModal
                      isOpen={isAddEditPetModalOpen}
                      onClose={() => setIsAddEditPetModalOpen(false)}
                      onSave={handleSavePet}
                      initialPetData={selectedPet}
                      speciesList={speciesList}
                      patternMap={patternMap}
                      themeClasses={themeClasses}
                      allPets={pets} // Pass all pets for parent selection
                    />

                    <PetDetailModal
                      isOpen={isPetDetailModalOpen}
                      onClose={() => setIsPetDetailModalOpen(false)}
                      pet={selectedPet}
                      allPets={pets}
                      themeClasses={themeClasses}
                    />

                    <ConfirmDeleteModal
                      isOpen={isConfirmDeletePetModalOpen}
                      onClose={() => setIsConfirmDeletePetModalOpen(false)}
                      onConfirm={confirmDeletePet}
                      message={`Are you sure you want to delete ${petToDelete?.name || 'this pet'}? This action cannot be undone.`}
                      themeClasses={themeClasses}
                    />
                  </div>
                )}
                {currentSubPage === 'relations' && (
                  <div className="space-y-6">
                    <h3 className={`text-2xl font-semibold ${themeClasses.textPrimary} mb-4 atomic-age-heading`}>Pet Relations</h3>

                    {relationsMessage && (
                      <p className={`text-center text-sm mb-4 p-2 rounded-lg ${themeClasses.bgMessage} ${themeClasses.textMessage}`}>
                        {relationsMessage}
                      </p>
                    )}

                    <p className={`${themeClasses.textSecondary} text-sm mb-6`}>
                      This section displays pets and their assigned parent-offspring relationships. To add or edit pets, including their parents, please go to the "Pets" tab.
                    </p>

                    {offspringList.length === 0 && pets.length === 0 ? (
                      <p className={`${themeClasses.textSecondary} text-lg`}>No pets found yet. Add pets in the "Pets" tab to see relations here.</p>
                    ) : offspringList.length === 0 ? (
                        <p className={`${themeClasses.textSecondary} text-lg`}>No offspring relations recorded yet. Add parents to your pets in the "Pets" tab to see them here.</p>
                    ) : (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 max-h-[40rem] overflow-y-auto p-2 rounded-lg border">
                        {offspringList.map(offspring => {
                          const parentNames = offspring.parents.map(parentId => {
                            const parent = pets.find(p => p.id === parentId);
                            return parent ? parent.name : 'Unknown Parent';
                          }).join(' & ');

                          return (
                            <div key={offspring.id} className={`${themeClasses.bgGoalItem} p-2 rounded-lg shadow-md ${themeClasses.borderGoalItem} border text-left relative`}>
                              {offspring.imageLink && (
                                <div className="flex justify-center mb-2">
                                  <img
                                    src={offspring.imageLink}
                                    alt={`Image of ${offspring.name}`}
                                    className="max-w-full h-auto max-h-16 object-contain rounded-lg"
                                    onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/80x80/e0e0e0/333333?text=No+Image"; }}
                                  />
                                </div>
                              )}
                              <h4 className={`font-bold text-md ${themeClasses.textPrimary}`}>{offspring.name}</h4>
                              {offspring.petNumber && <p className={`${themeClasses.textSecondary} text-xs`}>ID: {offspring.petNumber}</p>}
                              <p className={`${themeClasses.textSecondary} text-xs`}>Species: {offspring.species || 'N/A'} - {offspring.pattern || 'No Pattern'}</p>
                              <p className={`${themeClasses.textSecondary} text-xs`}>Gender: {offspring.gender || 'N/A'}</p>
                              <p className={`${themeClasses.textSecondary} text-xs`}>Parents: {parentNames}</p>
                              <div className="flex justify-end gap-1 mt-2">
                                <button
                                  onClick={() => handleViewPetDetail(offspring)}
                                  className={`px-2 py-1 text-xs rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} transition-colors`}
                                >
                                  View Details
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}
                {currentSubPage === 'projectLog' && (
                  <div className="space-y-6">
                    <h3 className={`text-2xl font-semibold ${themeClasses.textPrimary} mb-4 atomic-age-heading`}>Project Log</h3>

                    {projectLogMessage && (
                      <p className={`text-center text-sm mb-4 p-2 rounded-lg ${themeClasses.bgMessage} ${themeClasses.textMessage}`}>
                        {projectLogMessage}
                      </p>
                    )}

                    <button
                      onClick={handleAddProject}
                      className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300 ease-in-out focus:outline-none focus:ring-2 ${themeClasses.focusRingButtonPrimary} focus:ring-opacity-75 mb-6`}
                    >
                      Add New Project
                    </button>

                    {projects.length === 0 ? (
                      <p className={`${themeClasses.textSecondary} text-lg`}>No projects added yet.</p>
                    ) : (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-2 rounded-lg border">
                        {projects.map(project => (
                          <div key={project.id} className={`${themeClasses.bgGoalItem} p-4 rounded-lg shadow-md ${themeClasses.borderGoalItem} border text-left relative`}>
                            <h4 className={`font-bold text-lg ${themeClasses.textPrimary}`}>
                                {project.species} {project.pattern ? `(${project.pattern})` : ''} Project
                            </h4>
                            <p className={`${themeClasses.textSecondary} text-sm`}>
                                Starter Pairs: {project.starterPairs}
                            </p>
                            <p className={`${themeClasses.textSecondary} text-sm`}>
                                Added: {project.dateAdded}
                            </p>
                            <div className="flex justify-end gap-2 mt-3">
                              <button
                                onClick={() => handleViewProjectDetail(project)}
                                className={`px-3 py-1 text-sm rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} transition-colors`}
                                >
                                View
                              </button>
                              <button
                                onClick={() => handleEditProject(project)}
                                className={`px-3 py-1 text-sm rounded-lg ${themeClasses.bgButtonAdd} ${themeClasses.hoverBgButtonAdd} ${themeClasses.textButtonAdd} transition-colors`}
                              >
                                Edit
                              </button>
                              <button
                                onClick={() => handleDeleteProject(project)}
                                className={`px-3 py-1 text-sm rounded-lg bg-red-500 hover:bg-red-700 text-white transition-colors`}
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}

                    <AddEditProjectModal
                      isOpen={isAddEditProjectModalOpen}
                      onClose={() => setIsAddEditProjectModalOpen(false)}
                      onSave={handleSaveProject}
                      initialProjectData={selectedProject}
                      speciesList={speciesList}
                      patternMap={patternMap}
                      themeClasses={themeClasses}
                    />

                    <ProjectDetailModal
                      isOpen={isProjectDetailModalOpen}
                      onClose={() => setIsProjectDetailModalOpen(false)}
                      project={selectedProject}
                      themeClasses={themeClasses}
                    />

                    <ConfirmDeleteModal
                      isOpen={isConfirmDeleteProjectModalOpen}
                      onClose={() => setIsConfirmDeleteProjectModalOpen(false)}
                      onConfirm={confirmDeleteProject}
                      message={`Are you sure you want to delete this project? This action cannot be undone.`}
                      themeClasses={themeClasses}
                    />
                  </div>
                )}
                {currentSubPage === 'settings' && (
                  <div className="space-y-6">
                    <h3 className={`text-2xl font-semibold ${themeClasses.textPrimary} mb-4 atomic-age-heading`}>Settings</h3>

                    {settingsMessage && (
                      <p className={`text-center text-sm mb-4 p-2 rounded-lg ${themeClasses.bgMessage} ${themeClasses.textMessage}`}>
                        {settingsMessage}
                      </p>
                    )}

                    {/* Add Species Section */}
                    <div className={`${themeClasses.bgSection} p-4 rounded-lg shadow-inner ${themeClasses.borderSection} border`}>
                      <h4 className={`text-xl font-semibold ${themeClasses.textPrimary} mb-3`}>Manage Species</h4>
                      <div className="flex flex-col sm:flex-row gap-2 mb-4">
                        <input
                          type="text"
                          value={newSpeciesName}
                          onChange={(e) => setNewSpeciesName(e.target.value)}
                          placeholder="Add new species (e.g., Dragon)"
                          className={`flex-grow p-2 rounded-lg ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} focus:ring-opacity-50 ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                        />
                        <button
                          onClick={addSpecies}
                          className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300 ease-in-out focus:outline-none focus:ring-2 ${themeClasses.focusRingButtonPrimary} focus:ring-opacity-75`}
                        >
                          Add Species
                        </button>
                      </div>
                      <div className="max-h-40 overflow-y-auto">
                        {speciesList.length === 0 ? (
                          <p className={`${themeClasses.textSecondary} text-sm`}>No species added yet.</p>
                        ) : (
                          <ul className="list-disc list-inside text-left space-y-1">
                            {speciesList.map((species, index) => (
                              <li key={index} className={`${themeClasses.textPrimary} flex justify-between items-center`}>
                                {species}
                                <button
                                  onClick={() => deleteSpecies(species)}
                                  className={`${themeClasses.textDeleteButton} hover:${themeClasses.hoverTextDeleteButton} text-sm ml-2`}
                                >
                                  Delete
                                </button>
                              </li>
                            ))}
                          </ul>
                        )}
                      </div>
                    </div>

                    {/* Add Pattern Section */}
                    <div className={`${themeClasses.bgSection} p-4 rounded-lg shadow-inner ${themeClasses.borderSection} border`}>
                      <h4 className={`text-xl font-semibold ${themeClasses.textPrimary} mb-3`}>Manage Patterns by Species</h4>
                      <div className="flex flex-col sm:flex-row gap-2 mb-4 items-center">
                        <select
                          value={selectedSpeciesForPattern}
                          onChange={(e) => setSelectedSpeciesForPattern(e.target.value)}
                          className={`flex-grow p-2 rounded-lg ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput}`}
                        >
                          {speciesList.length === 0 ? (
                            <option value="">No species available</option>
                          ) : (
                            speciesList.map((species, index) => (
                              <option key={index} value={species}>{species}</option>
                            ))
                          )}
                        </select>
                        <input
                          type="text"
                          value={newPatternName}
                          onChange={(e) => setNewPatternName(e.target.value)}
                          placeholder="Add new pattern (e.g., Striped)"
                          className={`flex-grow p-2 rounded-lg ${themeClasses.bgInput} ${themeClasses.borderInput} border ${themeClasses.focusBorderInput} focus:ring ${themeClasses.focusRingInput} ${themeClasses.textInput} ${themeClasses.placeholderInput}`}
                          disabled={speciesList.length === 0}
                        />
                        <button
                          onClick={addPattern}
                          className={`px-4 py-2 rounded-lg ${themeClasses.bgButtonPrimary} ${themeClasses.hoverBgButtonPrimary} ${themeClasses.textButtonPrimary} font-bold transition duration-300 ease-in-out focus:outline-none focus:ring-2 ${themeClasses.focusRingButtonPrimary} focus:ring-opacity-75`}
                        >
                          Add Pattern
                        </button>
                      </div>
                      <div className="max-h-60 overflow-y-auto">
                        {Object.keys(patternMap).length === 0 ? (
                          <p className={`${themeClasses.textSecondary} text-sm`}>No patterns added yet.</p>
                        ) : (
                          <div className="space-y-4">
                            {Object.entries(patternMap).map(([species, patterns]) => (
                              <div key={species} className="text-left">
                                <h5 className={`font-semibold ${themeClasses.textPrimary} text-md mb-1`}>{species} Patterns:</h5>
                                {patterns.length === 0 ? (
                                  <p className={`${themeClasses.textSecondary} text-sm ml-4`}>No patterns for this species.</p>
                                ) : (
                                  <ul className="list-disc list-inside text-left space-y-1 ml-4">
                                    {patterns.map((pattern, index) => (
                                      <li key={index} className={`${themeClasses.textPrimary} flex justify-between items-center`}>
                                        {pattern}
                                        <button
                                          onClick={() => deletePattern(species, pattern)}
                                          className={`${themeClasses.textDeleteButton} hover:${themeClasses.hoverTextDeleteButton} text-sm ml-2`}
                                        >
                                          Delete
                                        </button>
                                      </li>
                                    ))}
                                  </ul>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };


        // Main App component for the standalone Breeding Tracker
        const App = () => {
          const [currentTheme, setCurrentTheme] = useState('white-grey'); // Default theme
          const [showThemesMenu, setShowThemesMenu] = useState(false);
          const [currentBreedingSubPage, setCurrentBreedingSubPage] = useState('dashboard'); // State for Breeding Projects sub-navigation

          // Load theme from local storage on initial render
          useEffect(() => {
            try {
              const storedTheme = localStorage.getItem('gameBankTrackerTheme'); // Using the key from the main app
              if (storedTheme && themes[storedTheme]) {
                setCurrentTheme(storedTheme);
              }
            } catch (error) {
              console.error("Failed to load theme from local storage:", error);
            }
          }, []);

          // Save theme to local storage whenever it changes
          useEffect(() => {
            try {
              localStorage.setItem('gameBankTrackerTheme', currentTheme);
            } catch (error) {
              console.error("Failed to save theme to local storage:", error);
            }
          }, [currentTheme]);

          const themeClasses = themes[currentTheme];

          return (
            <div className={`min-h-screen ${themeClasses.bgScreen} flex flex-col items-center p-4 font-inter`}>
              {/* Header for the standalone app */}
              <div className={`w-full ${themeClasses.bgButtonPrimary} p-4 shadow-lg fixed top-0 left-0 right-0 z-10 flex flex-col items-center justify-center`}>
                <div className="flex items-center justify-center w-full relative mb-2">
                  <h1 className={`text-3xl md:text-4xl font-extrabold tracking-tight text-center ${themeClasses.bannerText}`}>
                    Breeding Projects Tracker
                  </h1>
                  {/* Theme Button */}
                  <div className="absolute top-0 right-4 z-20">
                    <button
                      onClick={() => setShowThemesMenu(!showThemesMenu)}
                      className={`w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-colors duration-200
                        ${themeClasses.bgButtonPrimary.replace('bg-[', 'bg-').replace(']', '')}
                        ${themeClasses.borderContainer.replace('border-[', 'border-').replace(']', '')}
                        ${themeClasses.textButtonPrimary}
                      `}
                      aria-label="Change theme"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5">
                        <path fillRule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-1.002.607-2.29-.207-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.006z" clipRule="evenodd" />
                    </svg>
                    </button>

                    {showThemesMenu && (
                      <div className={`absolute mt-2 right-0 w-40 rounded-lg shadow-lg ${themeClasses.bgContainer} ${themeClasses.borderContainer} border py-1`}>
                        {Object.entries(themes).map(([key, theme]) => (
                          <button
                            key={key}
                            onClick={() => {
                              setCurrentTheme(key);
                              setShowThemesMenu(false);
                            }}
                            className={`block w-full text-left px-4 py-2 text-sm ${themeClasses.textPrimary} hover:${themeClasses.bgSection} rounded-md`}
                          >
                            {theme.name}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Main content area, pushed down by the fixed header */}
              <div className="flex flex-grow items-center justify-center mt-28 w-full">
                <BreedingProjectsContent themeClasses={themeClasses} currentSubPage={currentBreedingSubPage} setCurrentSubPage={setCurrentBreedingSubPage} />
              </div>
            </div>
          );
        };

        // Use createRoot for React 18
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
